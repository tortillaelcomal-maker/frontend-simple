<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Comal - Registros</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #D2691E 0%, #FF6347 50%, #FFD700 100%);
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('img/LogoComal.jpg') center/cover;
            opacity: 0.05;
            z-index: -1;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: linear-gradient(135deg, #D2691E 0%, #FF6347 100%);
            color: white; 
            padding: 1rem; 
            text-align: center; 
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(210, 105, 30, 0.3);
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('img/LogoComal.jpg') center/cover;
            opacity: 0.1;
            z-index: 0;
        }
        .header-content {
            position: relative;
            z-index: 1;
        }
        .logo-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .logo-header img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .header h1 {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }
        .controls { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(210, 105, 30, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .btn { 
            background: linear-gradient(135deg, #D2691E 0%, #FF6347 100%);
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 10px; 
            cursor: pointer; 
            margin: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn:hover { 
            background: linear-gradient(135deg, #B8860B 0%, #CD5C5C 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(210, 105, 30, 0.4);
        }
        .table-container { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px; 
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(210, 105, 30, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #ddd; }
        th { 
            background: linear-gradient(135deg, rgba(210, 105, 30, 0.1) 0%, rgba(255, 215, 0, 0.1) 100%);
            font-weight: bold;
            color: #8B4513;
            border-bottom: 2px solid rgba(210, 105, 30, 0.2);
        }
        input[type="number"] { width: 60px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 3px; }
        .total-row { 
            background: linear-gradient(135deg, rgba(210, 105, 30, 0.15) 0%, rgba(255, 215, 0, 0.15) 100%);
            font-weight: bold;
            color: #8B4513;
        }
        .message { padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 10% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; }
        .close { float: right; font-size: 28px; cursor: pointer; }
        .user-info { text-align: right; margin-bottom: 10px; color: #666; }
        .gorditas-icon { 
            margin-left: 10px; 
            cursor: pointer; 
            font-size: 18px; 
            color: #D2691E; 
            padding: 2px 5px; 
            border-radius: 8px; 
            background: rgba(210, 105, 30, 0.1);
            transition: all 0.3s ease;
        }
        .gorditas-icon:hover { 
            background: rgba(210, 105, 30, 0.2);
            transform: scale(1.1);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header { padding: 15px; }
            .header h1 { font-size: 1.5rem; }
            .header p { font-size: 0.9rem; }
            
            .controls { padding: 15px; }
            .btn { 
                padding: 8px 12px; 
                font-size: 12px; 
                margin: 3px; 
                display: inline-block;
                min-width: auto;
            }
            
            /* Stack buttons in mobile */
            .controls .btn {
                width: calc(50% - 6px);
                margin: 3px;
                text-align: center;
            }
            
            /* Table responsive - horizontal scroll */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -10px;
                padding: 0 10px;
            }
            
            table {
                min-width: 700px;
                font-size: 12px;
            }
            
            th, td {
                padding: 6px 4px;
                white-space: nowrap;
            }
            
            th:first-child, td:first-child {
                position: sticky;
                left: 0;
                background: white;
                z-index: 1;
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            }
            
            th:first-child {
                background: #f8f9fa;
            }
            
            input[type="number"] {
                width: 50px;
                padding: 3px;
                font-size: 11px;
            }
            
            .user-info {
                text-align: center;
                font-size: 14px;
                margin-bottom: 15px;
            }
            
            /* Modal adjustments */
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 15px;
            }
            
            .close {
                font-size: 24px;
            }
        }
        
        @media (max-width: 480px) {
            .container { padding: 5px; }
            .header { padding: 10px; }
            .header h1 { font-size: 1.3rem; }
            
            .controls { padding: 10px; }
            .controls .btn {
                width: 100%;
                margin: 2px 0;
                padding: 10px;
                font-size: 13px;
            }
            
            table { font-size: 11px; }
            th, td { padding: 4px 2px; }
            
            input[type="number"] {
                width: 45px;
                padding: 2px;
                font-size: 10px;
            }
            
            .modal-content {
                width: 98%;
                margin: 2% auto;
                padding: 10px;
            }
            
            /* Gorditas modal adjustments */
            #modalGorditas .modal-content {
                font-size: 14px;
            }
            
            #modalGorditas input {
                width: 80px;
                margin: 5px 0;
            }
            
            #modalGorditas label {
                display: block;
                margin: 10px 0 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo-header">
                    <img src="img/LogoComal.jpg" alt="Logo Tortiller√≠a El Comal">
                    <h1>Tortiller√≠a El Comal</h1>
                </div>
                <p>Sistema de Registros Diarios</p>
            </div>
        </div>

        <div class="user-info">
            Usuario: <span id="usuarioActual">-</span> | 
            <a href="#" onclick="cerrarSesion()" style="color: #666;">Cerrar Sesi√≥n</a>
        </div>

        <div class="controls">
            <button class="btn" onclick="mostrarNuevaRuta()">üìÖ Nueva Ruta</button>
            <button class="btn" onclick="mostrarRutasExistentes()">üìã Ver Rutas Existentes</button>
            <button class="btn" onclick="guardarTodos()">üíæ Guardar Todo</button>
            <button class="btn" onclick="irAAdminTiendas()" style="background: #6f42c1;">üè™ Administrar Tiendas</button>
            <button class="btn" onclick="irAPanelAdmin()" id="btnPanelAdmin" style="background: #dc3545; display: none;">üõ†Ô∏è Panel Admin</button>
            <button class="btn" onclick="irABlockNotas()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üìù Block de Notas</button>
            <div style="margin-top: 10px;">
                <strong>Ruta actual: <span id="rutaActual">Selecciona una fecha</span></strong>
            </div>
        </div>

        <div id="mensaje"></div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Tienda</th>
                        <th>Kilos</th>
                        <th>Cambios</th>
                        <th>Frijoles</th>
                        <th>Salsas</th>
                        <th>Totopos</th>
                        <th>Total</th>
                        <th>Importe</th>
                    </tr>
                </thead>
                <tbody id="registrosBody">
                    <tr><td colspan="8" style="text-align: center; padding: 40px;">Selecciona "Nueva Ruta" para comenzar</td></tr>
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td><strong>TOTALES</strong></td>
                        <td id="totalKilos">0</td>
                        <td id="totalCambios">0</td>
                        <td id="totalFrijoles">0</td>
                        <td id="totalSalsas">0</td>
                        <td id="totalTotopos">0</td>
                        <td id="totalGeneral">0</td>
                        <td id="totalImporte">$0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Modal Nueva Ruta -->
    <div id="modalNuevaRuta" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalNuevaRuta()">&times;</span>
            <h2>üìÖ Nueva Ruta</h2>
            <div style="margin: 20px 0;">
                <label>D√≠a:</label>
                <select id="nuevoDia"></select>
                <label>Mes:</label>
                <select id="nuevoMes"></select>
                <label>A√±o:</label>
                <select id="nuevoAno"></select>
            </div>
            <button class="btn" onclick="crearNuevaRuta()">Crear Ruta</button>
        </div>
    </div>

    <!-- Modal Rutas Existentes -->
    <div id="modalRutasExistentes" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalRutasExistentes()">&times;</span>
            <h2>üìã Rutas Existentes</h2>
            <div id="listaRutas" style="max-height: 400px; overflow-y: auto; margin: 20px 0;"></div>
        </div>
    </div>


    <!-- Modal Gorditas Especial -->
    <div id="modalGorditas" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalGorditas()">&times;</span>
            <h2>üßÆ C√°lculo Especial - GORDITAS</h2>
            <p style="color: #666; margin-bottom: 20px;">Esta tienda consume solo kilos de masa y frijoles en cantidades espec√≠ficas.</p>
            
            <div style="margin: 20px 0;">
                <div style="margin: 15px 0;">
                    <label><strong>Kilos de Masa:</strong></label>
                    <input type="number" id="gorditasKilosMasa" min="0" step="0.1" placeholder="Ej: 2.5" style="width: 100px; margin-left: 10px;">
                    <span style="margin-left: 10px;">√ó Precio del kilo: $</span>
                    <input type="number" id="gorditasPrecioMasa" min="0" step="0.01" placeholder="0.00" style="width: 80px;">
                </div>
                
                <div style="margin: 15px 0;">
                    <label><strong>Frijoles (cantidad monetaria):</strong></label>
                    <input type="number" id="gorditasFrijoles" min="0" step="0.01" placeholder="0.00" style="width: 100px; margin-left: 10px;">
                    <span style="margin-left: 10px;">pesos</span>
                </div>
                
                <hr style="margin: 20px 0;">
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                    <div style="margin: 10px 0;">
                        <strong>Resumen del C√°lculo:</strong>
                    </div>
                    <div id="gorditasResumen" style="margin: 10px 0; font-family: monospace;">
                        Kilos de masa: 0 √ó $0 = $0.00<br>
                        Frijoles: $0.00<br>
                        <strong>Total: $0.00</strong>
                    </div>
                </div>
            </div>
            
            <div style="text-align: right;">
                <button class="btn" style="background: #6c757d;" onclick="cerrarModalGorditas()">Cancelar</button>
                <button class="btn" onclick="aplicarCalculoGorditas()">Aplicar C√°lculo</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const API_BASE = CONFIG.API_BASE_URL;
        let fechaActual = '';
        let PRECIOS = { kilos: 18, frijoles: 14, salsas: 13, totopos: 18, cambios: 0 };

        let TIENDAS_ACTIVAS = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            verificarAutenticacion();
            cargarPrecios();
            cargarTiendasActivas();
            inicializarFechas();
        });

        function getToken() {
            return localStorage.getItem('token');
        }

        function verificarAutenticacion() {
            const token = getToken();
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                document.getElementById('usuarioActual').textContent = payload.nombre || 'Usuario';
                
                // Mostrar bot√≥n Panel Admin solo para administradores
                if (payload.rol === 'admin') {
                    document.getElementById('btnPanelAdmin').style.display = 'inline-block';
                }
            } catch (error) {
                window.location.href = 'login.html';
            }
        }

        function cerrarSesion() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            }
        }

        async function cargarPrecios() {
            try {
                const response = await fetch(`${API_BASE}/registros/precios`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) PRECIOS = result.precios;
                }
            } catch (error) {
                console.error('Error cargando precios:', error);
            }
        }

        async function cargarTiendasActivas() {
            try {
                const response = await fetch(`${API_BASE}/tiendas/activas`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        TIENDAS_ACTIVAS = result.tiendas.map(t => t.nombre);
                    }
                }
            } catch (error) {
                console.error('Error cargando tiendas:', error);
                // Fallback to hardcoded list if API fails - exact order from user's image
                TIENDAS_ACTIVAS = [
                    'GOYITA', 'SAUCILLO', 'SAGRADO', 'SANTA ANITA', 'SAN JUDAS', 
                    'ANEXO', 'GUERA', 'CHUNDE', 'PIEDRERA', 'JUANJO', 'ALAN', 
                    'DIANA', 'PORVENIR', 'ESCUELA', 'PUENYE', 'CLIENTE', 
                    'PINTADA', 'DON', 'RICHARD', 'ALI', 'EDIEL', 'LETTY', 
                    'ROSTI', 'NUEVA', 'PONY', 'TAQUERA', 'PATY', 'GORDITAS', 
                    'DON CHAVA', 'ESQUINA'
                ];
            }
        }

        function inicializarFechas() {
            const hoy = new Date();
            const dias = document.getElementById('nuevoDia');
            const meses = document.getElementById('nuevoMes');
            const anos = document.getElementById('nuevoAno');

            for (let i = 1; i <= 31; i++) {
                dias.innerHTML += `<option value="${i.toString().padStart(2, '0')}">${i}</option>`;
            }
            for (let i = 1; i <= 12; i++) {
                meses.innerHTML += `<option value="${i.toString().padStart(2, '0')}">${i}</option>`;
            }
            for (let i = hoy.getFullYear(); i >= hoy.getFullYear() - 2; i--) {
                anos.innerHTML += `<option value="${i}">${i}</option>`;
            }

            dias.value = hoy.getDate().toString().padStart(2, '0');
            meses.value = (hoy.getMonth() + 1).toString().padStart(2, '0');
            anos.value = hoy.getFullYear();
        }

        function mostrarNuevaRuta() {
            document.getElementById('modalNuevaRuta').style.display = 'block';
        }

        function cerrarModalNuevaRuta() {
            document.getElementById('modalNuevaRuta').style.display = 'none';
        }

        async function crearNuevaRuta() {
            const dia = document.getElementById('nuevoDia').value;
            const mes = document.getElementById('nuevoMes').value;
            const ano = document.getElementById('nuevoAno').value;
            fechaActual = `${ano}-${mes}-${dia}`;
            
            cargarRegistros();
            cerrarModalNuevaRuta();
            mostrarMensaje(`Nueva ruta: ${formatearFecha(fechaActual)}`, 'success');
        }

        async function cargarRegistros() {
            document.getElementById('rutaActual').textContent = formatearFecha(fechaActual);
            const tbody = document.getElementById('registrosBody');
            
            // Get tiendas for this specific date (includes historical tiendas)
            let tiendasParaFecha = TIENDAS_ACTIVAS;
            
            if (fechaActual) {
                try {
                    const response = await fetch(`${API_BASE}/tiendas/para-fecha?fecha=${fechaActual}`, {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            tiendasParaFecha = result.tiendas;
                        }
                    }
                } catch (error) {
                    console.error('Error cargando tiendas para fecha:', error);
                    // Fallback to active tiendas if API fails
                }
            }
            
            tbody.innerHTML = tiendasParaFecha.map(tienda => `
                <tr>
                    <td>
                        <strong>${tienda}</strong>
                        ${tienda === 'GORDITAS' ? '<span class="gorditas-icon" onclick="mostrarModalGorditas()" title="C√°lculo especial para Gorditas">üßÆ</span><br><small style="color: #666;">kilos</small>' : ''}
                    </td>
                    <td><input type="number" data-tienda="${tienda}" data-field="kilos" min="0" step="0.5" onchange="calcularTotal(this)" ${tienda === 'GORDITAS' ? 'readonly style="background: #f0f0f0;"' : ''}></td>
                    <td><input type="number" data-tienda="${tienda}" data-field="cambios" min="0" step="0.5" onchange="calcularTotal(this)"></td>
                    <td><input type="number" data-tienda="${tienda}" data-field="frijoles" min="0" onchange="calcularTotal(this)" ${tienda === 'GORDITAS' ? 'readonly style="background: #f0f0f0;"' : ''}></td>
                    <td><input type="number" data-tienda="${tienda}" data-field="salsas" min="0" onchange="calcularTotal(this)"></td>
                    <td><input type="number" data-tienda="${tienda}" data-field="totopos" min="0" onchange="calcularTotal(this)"></td>
                    <td class="total-tienda" data-tienda="${tienda}">0</td>
                    <td class="importe-tienda" data-tienda="${tienda}">$0.00</td>
                </tr>
            `).join('');

            cargarDatosExistentes();
        }

        async function cargarDatosExistentes() {
            if (!fechaActual) return;
            try {
                const response = await fetch(`${API_BASE}/registros/load-ruta?fecha=${fechaActual}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.datos) {
                        Object.keys(result.datos).forEach(tienda => {
                            const registro = result.datos[tienda];
                            const inputs = document.querySelectorAll(`input[data-tienda="${tienda}"]`);
                            inputs.forEach(input => {
                                const field = input.getAttribute('data-field');
                                if (registro[field] !== undefined) {
                                    input.value = registro[field] || 0;
                                }
                            });
                            
                            // Special handling for GORDITAS - restore custom calculation if it exists
                            if (tienda === 'GORDITAS' && registro.observaciones && registro.observaciones.includes('GORDITAS_CALC:')) {
                                try {
                                    const calcData = JSON.parse(registro.observaciones.replace('GORDITAS_CALC:', ''));
                                    window.gorditasCalculation = calcData;
                                } catch (e) {
                                    console.log('Could not parse GORDITAS calculation data');
                                    window.gorditasCalculation = null;
                                }
                            }
                            
                            calcularTotalTienda(tienda);
                        });
                        calcularTotalesGenerales();
                    } else {
                        // If no data exists for this date, ensure all inputs are empty
                        const allInputs = document.querySelectorAll('input[data-tienda]');
                        allInputs.forEach(input => {
                            input.value = '';
                        });
                        calcularTotalesGenerales();
                    }
                } else {
                    mostrarMensaje('Error cargando datos existentes', 'error');
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                mostrarMensaje('Error de conexi√≥n al cargar datos', 'error');
            }
        }

        function calcularTotal(input) {
            const tienda = input.getAttribute('data-tienda');
            calcularTotalTienda(tienda);
            calcularTotalesGenerales();
        }

        function calcularTotalTienda(tienda) {
            const inputs = document.querySelectorAll(`input[data-tienda="${tienda}"]`);
            let total = 0;
            let importe = 0;
            let cambiosValor = 0;
            
            // Special handling for GORDITAS
            if (tienda === 'GORDITAS' && window.gorditasCalculation) {
                const kilosInput = document.querySelector(`input[data-tienda="GORDITAS"][data-field="kilos"]`);
                const frijolesInput = document.querySelector(`input[data-tienda="GORDITAS"][data-field="frijoles"]`);
                
                const kilosValue = parseFloat(kilosInput.value) || 0;
                const frijolesValue = parseFloat(frijolesInput.value) || 0;
                
                // Only use custom calculation if there are actual values
                if (kilosValue > 0 || frijolesValue > 0) {
                    // For GORDITAS: exclude both kilos AND frijoles from product total (per user request)
                    total = 0; // Neither kilos nor frijoles count in product total
                    importe = window.gorditasCalculation.totalAmount; // Use exact calculation
                } else {
                    // If no values, clear the calculation and use standard calculation
                    window.gorditasCalculation = null;
                    total = 0;
                    importe = 0;
                }
            } else {
                inputs.forEach(input => {
                    const field = input.getAttribute('data-field');
                    let valor = parseFloat(input.value) || 0;
                    
                    if (field === 'cambios') {
                        cambiosValor = valor;
                        // Cambios no se suma al total de productos, es una deducci√≥n monetaria
                    } else if (field === 'kilos') {
                        total += valor;
                        // Para kilos: precio completo para enteros, mitad del precio para decimales .5
                        const precioKilo = PRECIOS[field] || 0;
                        if (valor % 1 === 0.5) {
                            // Si es .5, cobrar precio completo por la parte entera + mitad del precio por el .5
                            const parteEntera = Math.floor(valor);
                            importe += (parteEntera * precioKilo) + (precioKilo / 2);
                        } else {
                            // Precio normal para enteros u otros decimales
                            importe += valor * precioKilo;
                        }
                    } else if (field === 'frijoles' || field === 'salsas' || field === 'totopos') {
                        // Para frijoles, salsas y totopos: solo valores enteros
                        valor = Math.floor(valor);
                        total += valor;
                        importe += valor * (PRECIOS[field] || 0);
                    }
                });
                
                // Restar el importe de cambios con l√≥gica de medios kilos
                const precioKilo = PRECIOS.kilos || 0;
                let deduccionCambios = 0;
                if (cambiosValor % 1 === 0.5) {
                    // Si cambios es .5, deducir precio completo por la parte entera + mitad por el .5
                    const parteEntera = Math.floor(cambiosValor);
                    deduccionCambios = (parteEntera * precioKilo) + (precioKilo / 2);
                } else {
                    // Deducci√≥n normal para enteros u otros decimales
                    deduccionCambios = cambiosValor * precioKilo;
                }
                importe -= deduccionCambios;
            }

            document.querySelector(`.total-tienda[data-tienda="${tienda}"]`).textContent = parseFloat(total.toFixed(2));
            document.querySelector(`.importe-tienda[data-tienda="${tienda}"]`).textContent = `$${importe.toFixed(2)}`;
        }

        function calcularTotalesGenerales() {
            let totalKilos = 0, totalCambios = 0, totalFrijoles = 0, totalSalsas = 0, totalTotopos = 0, totalImporte = 0;

            // Calculate totals for all tiendas currently displayed (not just active ones)
            const allInputs = document.querySelectorAll('input[data-tienda]');
            const tiendasEnPantalla = [...new Set(Array.from(allInputs).map(input => input.getAttribute('data-tienda')))];

            tiendasEnPantalla.forEach(tienda => {
                // Special handling for GORDITAS
                if (tienda === 'GORDITAS' && window.gorditasCalculation) {
                    // For GORDITAS, exclude both kilos AND frijoles from product totals (per user request)
                    // Only monetary calculation is included
                    totalImporte += window.gorditasCalculation.totalAmount;
                    // NOTE: Both kilos AND frijoles de GORDITAS are NOT included in totals
                } else {
                    // Standard calculation for other tiendas
                    const inputs = document.querySelectorAll(`input[data-tienda="${tienda}"]`);
                    let kilosValue = 0, cambiosValue = 0, frijolesValue = 0, salsasValue = 0, totopositosValue = 0;

                    inputs.forEach(input => {
                        const field = input.getAttribute('data-field');
                        const value = parseFloat(input.value) || 0;
                        
                        switch(field) {
                            case 'kilos': kilosValue = value; break;
                            case 'cambios': cambiosValue = value; break;
                            case 'frijoles': frijolesValue = value; break;
                            case 'salsas': salsasValue = value; break;
                            case 'totopos': totopositosValue = value; break;
                        }
                    });

                    totalKilos += kilosValue;
                    totalCambios += cambiosValue;
                    totalFrijoles += frijolesValue;
                    totalSalsas += salsasValue;
                    totalTotopos += totopositosValue;

                    // Calculate monetary amounts
                    let importeTienda = (kilosValue * PRECIOS.kilos) + (frijolesValue * PRECIOS.frijoles) + 
                                      (salsasValue * PRECIOS.salsas) + (totopositosValue * PRECIOS.totopos);
                    
                    // Handle cambios deduction
                    if (cambiosValue > 0) {
                        if (cambiosValue % 1 === 0.5) {
                            const parteEntera = Math.floor(cambiosValue);
                            importeTienda -= (parteEntera * PRECIOS.kilos) + (PRECIOS.kilos / 2);
                        } else {
                            importeTienda -= cambiosValue * PRECIOS.kilos;
                        }
                    }
                    
                    totalImporte += importeTienda;
                }
            });

            document.getElementById('totalKilos').textContent = parseFloat(totalKilos.toFixed(2));
            document.getElementById('totalCambios').textContent = parseFloat(totalCambios.toFixed(2));
            document.getElementById('totalFrijoles').textContent = parseFloat(totalFrijoles.toFixed(2));
            document.getElementById('totalSalsas').textContent = parseFloat(totalSalsas.toFixed(2));
            document.getElementById('totalTotopos').textContent = parseFloat(totalTotopos.toFixed(2));
            document.getElementById('totalImporte').textContent = `$${totalImporte.toFixed(2)}`;
            // totalGeneral excludes GORDITAS kilos - only counts other tiendas' products
            const totalGeneral = totalKilos + totalCambios + totalFrijoles + totalSalsas + totalTotopos;
            document.getElementById('totalGeneral').textContent = parseFloat(totalGeneral.toFixed(2));
        }

        async function guardarTodos() {
            if (!fechaActual) {
                mostrarMensaje('Selecciona una fecha', 'error');
                return;
            }

            const datos = {};
            let hasData = false;
            
            // Save data for all tiendas currently displayed (not just active ones)
            const allInputs = document.querySelectorAll('input[data-tienda]');
            const tiendasEnPantalla = [...new Set(Array.from(allInputs).map(input => input.getAttribute('data-tienda')))];
            
            tiendasEnPantalla.forEach(tienda => {
                const inputs = document.querySelectorAll(`input[data-tienda="${tienda}"]`);
                datos[tienda] = {};
                let tiendaHasData = false;
                
                inputs.forEach(input => {
                    const field = input.getAttribute('data-field');
                    const value = parseFloat(input.value) || 0;
                    datos[tienda][field] = value;
                    if (value > 0) {
                        tiendaHasData = true;
                        hasData = true;
                    }
                });
                
                // Save GORDITAS calculation data in observaciones field
                if (tienda === 'GORDITAS' && window.gorditasCalculation) {
                    datos[tienda].observaciones = 'GORDITAS_CALC:' + JSON.stringify(window.gorditasCalculation);
                    tiendaHasData = true;
                    hasData = true;
                } else {
                    datos[tienda].observaciones = '';
                }
                
                // Only save tiendas that have actual data
                if (!tiendaHasData) {
                    delete datos[tienda];
                }
            });

            if (!hasData) {
                mostrarMensaje('No hay datos para guardar', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/registros/save-ruta`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({ fecha: fechaActual, datos })
                });

                const result = await response.json();
                if (result.success) {
                    mostrarMensaje(`Ruta guardada: ${formatearFecha(fechaActual)} (${Object.keys(datos).length} tiendas)`, 'success');
                } else {
                    mostrarMensaje(`Error al guardar: ${result.message || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                console.error('Error guardando:', error);
                mostrarMensaje('Error de conexi√≥n al guardar', 'error');
            }
        }

        async function mostrarRutasExistentes() {
            try {
                const response = await fetch(`${API_BASE}/registros/rutas-existentes`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                const result = await response.json();
                const listaRutas = document.getElementById('listaRutas');
                
                if (result.success && result.rutas.length > 0) {
                    listaRutas.innerHTML = result.rutas.map(ruta => `
                        <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; cursor: pointer;" onclick="cargarRutaExistente('${ruta.fecha}')">
                            <strong>${formatearFecha(ruta.fecha)}</strong>
                            <br><small>${ruta.numTiendas} registros</small>
                        </div>
                    `).join('');
                } else {
                    listaRutas.innerHTML = '<p style="text-align: center;">No hay rutas guardadas</p>';
                }
                
                document.getElementById('modalRutasExistentes').style.display = 'block';
            } catch (error) {
                mostrarMensaje('Error cargando rutas', 'error');
            }
        }

        function cerrarModalRutasExistentes() {
            document.getElementById('modalRutasExistentes').style.display = 'none';
        }

        function cargarRutaExistente(fecha) {
            fechaActual = fecha;
            cargarRegistros();
            cerrarModalRutasExistentes();
        }


        function formatearFecha(fecha) {
            const [ano, mes, dia] = fecha.split('-');
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            return `${parseInt(dia)} de ${meses[parseInt(mes) - 1]} de ${ano}`;
        }

        function irAPanelAdmin() {
            window.location.href = 'admin.html';
        }

        function irAAdminTiendas() {
            window.location.href = 'tiendas-admin.html';
        }

        function irABlockNotas() {
            window.location.href = 'notas.html';
        }

        // Funciones para Modal Gorditas
        function mostrarModalGorditas() {
            // Clear all fields - user must input everything
            document.getElementById('gorditasKilosMasa').value = '';
            document.getElementById('gorditasPrecioMasa').value = '';
            document.getElementById('gorditasFrijoles').value = '';
            
            actualizarResumenGorditas();
            document.getElementById('modalGorditas').style.display = 'block';
        }

        function cerrarModalGorditas() {
            document.getElementById('modalGorditas').style.display = 'none';
        }

        function actualizarResumenGorditas() {
            const kilosMasa = parseFloat(document.getElementById('gorditasKilosMasa').value) || 0;
            const frijolesPesos = parseFloat(document.getElementById('gorditasFrijoles').value) || 0;
            const precioMasa = parseFloat(document.getElementById('gorditasPrecioMasa').value) || 0;
            
            const importeKilos = kilosMasa * precioMasa;
            const totalImporte = importeKilos + frijolesPesos;
            
            document.getElementById('gorditasResumen').innerHTML = `
                Kilos de masa: ${kilosMasa} √ó $${precioMasa} = $${importeKilos.toFixed(2)}<br>
                Frijoles: $${frijolesPesos.toFixed(2)}<br>
                <strong>Total: $${totalImporte.toFixed(2)}</strong>
            `;
        }

        function aplicarCalculoGorditas() {
            const kilosMasa = parseFloat(document.getElementById('gorditasKilosMasa').value) || 0;
            const precioMasa = parseFloat(document.getElementById('gorditasPrecioMasa').value) || 0;
            const frijolesPesos = parseFloat(document.getElementById('gorditasFrijoles').value) || 0;
            
            // Validate inputs
            if (kilosMasa <= 0 || precioMasa <= 0 || frijolesPesos <= 0) {
                mostrarMensaje('Por favor ingresa todos los valores correctamente', 'error');
                return;
            }
            
            // Calculate total monetary amount for GORDITAS
            const totalGorditas = (kilosMasa * precioMasa) + frijolesPesos;
            
            // Calculate frijoles equivalent for the monetary amount
            const frijolesEquivalente = frijolesPesos / (PRECIOS.frijoles || 14);
            
            // Store values in the inputs
            const gorditasKilosInput = document.querySelector('input[data-tienda="GORDITAS"][data-field="kilos"]');
            const gorditasFrijolesInput = document.querySelector('input[data-tienda="GORDITAS"][data-field="frijoles"]');
            
            if (gorditasKilosInput) {
                gorditasKilosInput.value = kilosMasa; // Store actual kilos of masa
            }
            if (gorditasFrijolesInput) {
                gorditasFrijolesInput.value = frijolesEquivalente.toFixed(2); // Store frijoles equivalent
            }
            
            // Store special calculation data for correct monetary display
            window.gorditasCalculation = {
                totalAmount: totalGorditas,
                kilosMasa: kilosMasa,
                precioMasa: precioMasa,
                frijolesPesos: frijolesPesos
            };
            
            // Recalculate totals
            calcularTotalTienda('GORDITAS');
            calcularTotalesGenerales();
            
            cerrarModalGorditas();
            mostrarMensaje(`C√°lculo aplicado: ${kilosMasa}kg masa √ó $${precioMasa} + $${frijolesPesos} frijoles = $${totalGorditas.toFixed(2)}`, 'success');
        }

        // Add event listeners for real-time calculation updates
        document.addEventListener('DOMContentLoaded', () => {
            // Add event listeners after DOM is loaded
            setTimeout(() => {
                const kilosMasaInput = document.getElementById('gorditasKilosMasa');
                const frijolesInput = document.getElementById('gorditasFrijoles');
                const precioMasaInput = document.getElementById('gorditasPrecioMasa');
                
                if (kilosMasaInput) {
                    kilosMasaInput.addEventListener('input', actualizarResumenGorditas);
                }
                if (frijolesInput) {
                    frijolesInput.addEventListener('input', actualizarResumenGorditas);
                }
                if (precioMasaInput) {
                    precioMasaInput.addEventListener('input', actualizarResumenGorditas);
                }
            }, 100);
        });

        function mostrarMensaje(mensaje, tipo) {
            const div = document.getElementById('mensaje');
            div.innerHTML = `<div class="message ${tipo}">${mensaje}</div>`;
            setTimeout(() => div.innerHTML = '', 3000);
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
