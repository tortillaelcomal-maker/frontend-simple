<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sistema Comal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #D2691E 0%, #FF6347 50%, #FFD700 100%);
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('img/LogoComal.jpg') center/cover;
            opacity: 0.05;
            z-index: -1;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: linear-gradient(135deg, #D2691E 0%, #FF6347 100%);
            color: white; 
            padding: 1rem; 
            text-align: center; 
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(210, 105, 30, 0.3);
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('img/LogoComal.jpg') center/cover;
            opacity: 0.1;
            z-index: 0;
        }
        .header-content {
            position: relative;
            z-index: 1;
        }
        .logo-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .logo-header img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .header h1 {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(210, 105, 30, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .btn { 
            background: linear-gradient(135deg, #D2691E 0%, #FF6347 100%);
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 10px; 
            cursor: pointer; 
            margin: 5px; 
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn:hover { 
            background: linear-gradient(135deg, #B8860B 0%, #CD5C5C 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(210, 105, 30, 0.4);
        }
        .user-info { text-align: right; margin-bottom: 10px; color: #666; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; }
        th { 
            background: linear-gradient(135deg, rgba(210, 105, 30, 0.1) 0%, rgba(255, 215, 0, 0.1) 100%);
            color: #8B4513;
            border-bottom: 2px solid rgba(210, 105, 30, 0.2);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .dashboard { grid-template-columns: 1fr; gap: 15px; }
            .card { padding: 15px; }
            .btn { padding: 8px 15px; font-size: 13px; margin: 3px; }
            .header { padding: 15px; }
            .header h1 { font-size: 1.5rem; }
            .user-info { text-align: center; font-size: 14px; }
            
            /* Grid layout for report totals on mobile */
            .report-grid { 
                display: grid !important; 
                grid-template-columns: 1fr !important; 
                gap: 15px !important; 
            }
            
            /* Table responsive */
            table { font-size: 12px; }
            th, td { padding: 6px 4px; }
            
            /* Export buttons stack on mobile */
            .export-buttons { 
                display: flex; 
                flex-direction: column; 
                gap: 10px; 
                margin-top: 15px; 
            }
            .export-buttons .btn { 
                width: 100%; 
                margin: 0; 
            }
        }
        
        @media (max-width: 480px) {
            .container { padding: 5px; }
            .card { padding: 10px; }
            .btn { padding: 6px 12px; font-size: 12px; }
            .header h1 { font-size: 1.3rem; }
            
            /* Very small screens - make tables scrollable */
            .table-container { 
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch; 
            }
            table { min-width: 300px; }
            th, td { padding: 4px 2px; font-size: 11px; }
            
            /* Stack form elements */
            .form-row { 
                display: flex; 
                flex-direction: column; 
                gap: 10px; 
            }
            .form-row input, .form-row button { 
                width: 100%; 
            }
        }
        
        /* Utility classes for responsive design */
        .mobile-hidden { display: block; }
        .mobile-only { display: none; }
        
        @media (max-width: 768px) {
            .mobile-hidden { display: none; }
            .mobile-only { display: block; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo-header">
                    <img src="img/LogoComal.jpg" alt="Logo Tortiller√≠a El Comal">
                    <h1>Panel de Administraci√≥n</h1>
                </div>
                <p>Sistema Comal</p>
            </div>
        </div>

        <div class="user-info">
            Admin: <span id="usuarioActual">-</span> | 
            <a href="#" onclick="cerrarSesion()" style="color: #666;">Cerrar Sesi√≥n</a>
        </div>

        <div class="dashboard">

            <div class="card">
                <h3>üìä Reportes de Ventas</h3>
                <div class="form-row" style="margin-bottom: 15px;">
                    <label>Fecha:</label>
                    <input type="date" id="fechaReporte" style="margin: 5px;">
                    <button class="btn" onclick="generarReporteDia()">Reporte D√≠a</button>
                </div>
                <div id="resultadoReporte"></div>
            </div>

            <div class="card">
                <h3>üìà Reportes Autom√°ticos</h3>
                
                <!-- Selector de Mes/A√±o -->
                <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">üìÖ Seleccionar Mes:</label>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="mesSelector" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="01">Enero</option>
                            <option value="02">Febrero</option>
                            <option value="03">Marzo</option>
                            <option value="04">Abril</option>
                            <option value="05">Mayo</option>
                            <option value="06">Junio</option>
                            <option value="07">Julio</option>
                            <option value="08">Agosto</option>
                            <option value="09">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        <select id="anoSelector" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <!-- Se llena din√°micamente -->
                        </select>
                        <button class="btn" onclick="navegarMes(-1)" style="padding: 8px 12px;">‚óÄ Anterior</button>
                        <button class="btn" onclick="navegarMes(1)" style="padding: 8px 12px;">Siguiente ‚ñ∂</button>
                    </div>
                </div>
                
                <button class="btn" onclick="generarReporteMensual()">Generar Reporte del Mes</button>
                <div class="export-buttons" style="margin-top: 10px;">
                    <button class="btn" onclick="exportarExcel()" id="btnExcel" style="display: none; background-color: #28a745;">üìÑ Exportar Excel</button>
                    <button class="btn" onclick="exportarPDF()" id="btnPDF" style="display: none; background-color: #dc3545; margin-left: 10px;">üìã Exportar PDF</button>
                </div>
                <div id="reporteCompleto"></div>
            </div>

            <div class="card">
                <h3>üìã Rutas Recientes</h3>
                <button class="btn" onclick="verRutasRecientes()">Ver Rutas</button>
                <div id="rutasRecientes"></div>
            </div>

            <div class="card">
                <h3>üåÆ Acceso R√°pido</h3>
                <button class="btn" onclick="window.location.href='index.html'">Ver Sistema de Registros</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Libraries for Excel and PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="config.js"></script>
    <script>
        const API_BASE = CONFIG.API_BASE_URL;

        function getToken() {
            return localStorage.getItem('token');
        }

        // Funci√≥n auxiliar para formatear fechas correctamente sin problemas de zona horaria
        function formatearFecha(fechaString) {
            const fecha = new Date(fechaString);
            // Ajustar por zona horaria para evitar que se reste un d√≠a
            const fechaLocal = new Date(fecha.getTime() + fecha.getTimezoneOffset() * 60000);
            return fechaLocal.toLocaleDateString('es-MX');
        }

        function verificarAutenticacion() {
            const token = getToken();
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (payload.rol !== 'admin') {
                    window.location.href = 'index.html';
                    return;
                }
                document.getElementById('usuarioActual').textContent = payload.nombre || 'Admin';
            } catch (error) {
                window.location.href = 'login.html';
            }
        }

        function cerrarSesion() {
            if (confirm('¬øCerrar sesi√≥n?')) {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            }
        }


        function inicializarFechas() {
            const hoy = new Date();
            const year = hoy.getFullYear();
            const month = String(hoy.getMonth() + 1).padStart(2, '0');
            const day = String(hoy.getDate()).padStart(2, '0');
            document.getElementById('fechaReporte').value = `${year}-${month}-${day}`;
            
            // Inicializar selector de mes/a√±o
            inicializarSelectorMes();
        }

        function inicializarSelectorMes() {
            const hoy = new Date();
            const anoActual = hoy.getFullYear();
            const mesActual = (hoy.getMonth() + 1).toString().padStart(2, '0');
            
            // Llenar selector de a√±os (desde 2023 hasta a√±o actual + 1)
            const anoSelector = document.getElementById('anoSelector');
            anoSelector.innerHTML = '';
            for (let ano = 2023; ano <= anoActual + 1; ano++) {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                if (ano === anoActual) option.selected = true;
                anoSelector.appendChild(option);
            }
            
            // Seleccionar mes actual
            document.getElementById('mesSelector').value = mesActual;
        }

        function navegarMes(direccion) {
            const mesSelector = document.getElementById('mesSelector');
            const anoSelector = document.getElementById('anoSelector');
            
            let mes = parseInt(mesSelector.value);
            let ano = parseInt(anoSelector.value);
            
            mes += direccion;
            
            if (mes > 12) {
                mes = 1;
                ano++;
            } else if (mes < 1) {
                mes = 12;
                ano--;
            }
            
            mesSelector.value = mes.toString().padStart(2, '0');
            anoSelector.value = ano;
            
            // Regenerar reporte si ya hay uno visible
            if (document.getElementById('reporteCompleto').innerHTML.trim() !== '') {
                generarReporteMensual();
            }
        }

        async function generarReporteDia() {
            const fecha = document.getElementById('fechaReporte').value;
            if (!fecha) {
                alert('Selecciona una fecha');
                return;
            }

            try {
                // Obtener reporte de ventas
                const response = await fetch(`${API_BASE}/registros/reporte-dia?fecha=${fecha}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                const result = await response.json();
                
                // Obtener notas del d√≠a
                const notasResponse = await fetch(`${API_BASE}/notas/rango?fechaInicio=${fecha}&fechaFin=${fecha}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                const notasResult = await notasResponse.json();
                const div = document.getElementById('resultadoReporte');
                
                if (result.success && result.reporte) {
                    const r = result.reporte;
                    let notasHtml = '';
                    
                    if (notasResult.success && notasResult.notas.length > 0) {
                        notasHtml = `
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #D2691E;">
                                <h5 style="margin-bottom: 10px; color: #D2691E;">üìù Notas del D√≠a</h5>
                                ${notasResult.notas.map(nota => `
                                    <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                                        <strong style="color: #333;">${nota.titulo}</strong>
                                        <p style="margin: 5px 0; color: #666; font-size: 14px;">${nota.contenido}</p>
                                        <small style="color: #999;">Por: ${nota.nombreUsuario} - ${formatearFecha(nota.fecha)}</small>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    div.innerHTML = `
                        <h4>üìÖ Reporte del ${fecha}</h4>
                        <table style="width: 100%; margin-top: 10px;">
                            <tr><th>Concepto</th><th>Cantidad</th><th>Importe</th></tr>
                            <tr><td>Kilos</td><td>${parseFloat(r.totalKilos.toFixed(2))}</td><td>$${r.importeKilos.toFixed(2)}</td></tr>
                            <tr><td>Frijoles</td><td>${parseFloat(r.totalFrijoles.toFixed(2))}</td><td>$${r.importeFrijoles.toFixed(2)}</td></tr>
                            <tr><td>Salsas</td><td>${parseFloat(r.totalSalsas.toFixed(2))}</td><td>$${r.importeSalsas.toFixed(2)}</td></tr>
                            <tr><td>Totopos</td><td>${parseFloat(r.totalTotopos.toFixed(2))}</td><td>$${r.importeTotopos.toFixed(2)}</td></tr>
                            <tr><td>Cambios</td><td>${parseFloat(r.totalCambios.toFixed(2))}</td><td>$${r.importeCambios.toFixed(2)}</td></tr>
                            <tr style="background: #e8f5e8; font-weight: bold;">
                                <td>TOTAL</td><td>${parseFloat(r.totalGeneral.toFixed(2))}</td><td>$${r.importeTotal.toFixed(2)}</td>
                            </tr>
                        </table>
                        <p style="margin-top: 10px;"><strong>Tiendas registradas:</strong> ${r.numTiendas}</p>
                        ${notasHtml}
                    `;
                    
                    // Guardar datos para posible exportaci√≥n (incluyendo notas)
                    window.reporteDiaData = {
                        fecha: fecha,
                        reporte: r,
                        notas: notasResult.success ? notasResult.notas : []
                    };
                } else {
                    div.innerHTML = '<p>No hay datos para esta fecha</p>';
                }
            } catch (error) {
                document.getElementById('resultadoReporte').innerHTML = '<p>Error generando reporte</p>';
                console.error('Error:', error);
            }
        }


        async function verRutasRecientes() {
            try {
                const response = await fetch(`${API_BASE}/registros/rutas-existentes`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                const result = await response.json();
                const div = document.getElementById('rutasRecientes');
                
                if (result.success && result.rutas.length > 0) {
                    div.innerHTML = `
                        <table>
                            <tr><th>Fecha</th><th>Registros</th></tr>
                            ${result.rutas.slice(0, 5).map(r => `
                                <tr><td>${r.fecha}</td><td>${r.numTiendas}</td></tr>
                            `).join('')}
                        </table>
                    `;
                } else {
                    div.innerHTML = '<p>No hay rutas registradas</p>';
                }
            } catch (error) {
                document.getElementById('rutasRecientes').innerHTML = '<p>Error cargando rutas</p>';
            }
        }

        async function generarReporteMensual() {
            const mes = document.getElementById('mesSelector').value;
            const ano = document.getElementById('anoSelector').value;
            
            try {
                const response = await fetch(`${API_BASE}/registros/rutas-existentes`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                const result = await response.json();
                const div = document.getElementById('reporteCompleto');
                
                if (result.success && result.rutas.length > 0) {
                    // Filtrar rutas por el mes/a√±o seleccionado
                    const rutasDelMes = result.rutas.filter(ruta => {
                        const fechaRuta = new Date(ruta.fecha);
                        const mesRuta = (fechaRuta.getMonth() + 1).toString().padStart(2, '0');
                        const anoRuta = fechaRuta.getFullYear().toString();
                        return mesRuta === mes && anoRuta === ano;
                    });
                    
                    if (rutasDelMes.length === 0) {
                        div.innerHTML = `<p>No hay datos disponibles para ${getNombreMes(mes)} ${ano}</p>`;
                        document.getElementById('btnExcel').style.display = 'none';
                        document.getElementById('btnPDF').style.display = 'none';
                        return;
                    }
                    
                    // Obtener notas del mes
                    const fechaInicio = `${ano}-${mes}-01`;
                    const ultimoDia = new Date(ano, mes, 0).getDate();
                    const fechaFin = `${ano}-${mes}-${ultimoDia.toString().padStart(2, '0')}`;
                    
                    const notasResponse = await fetch(`${API_BASE}/notas/rango?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`, {
                        headers: { 'Authorization': `Bearer ${getToken()}` }
                    });
                    const notasResult = await notasResponse.json();
                    
                    let totalKilos = 0, totalFrijoles = 0, totalSalsas = 0, totalTotopos = 0, totalCambios = 0;
                    let totalImporte = 0;
                    let reportesPorFecha = [];
                    
                    // Generar reporte para cada fecha del mes
                    for (const ruta of rutasDelMes) {
                        try {
                            const reporteResponse = await fetch(`${API_BASE}/registros/reporte-dia?fecha=${ruta.fecha}`, {
                                headers: { 'Authorization': `Bearer ${getToken()}` }
                            });
                            const reporteResult = await reporteResponse.json();
                            
                            if (reporteResult.success && reporteResult.reporte) {
                                const r = reporteResult.reporte;
                                totalKilos += r.totalKilos || 0;
                                totalFrijoles += r.totalFrijoles || 0;
                                totalSalsas += r.totalSalsas || 0;
                                totalTotopos += r.totalTotopos || 0;
                                totalCambios += r.totalCambios || 0;
                                totalImporte += r.importeTotal || 0;
                                
                                reportesPorFecha.push({
                                    fecha: ruta.fecha,
                                    importe: r.importeTotal || 0,
                                    tiendas: r.numTiendas || 0
                                });
                            }
                        } catch (e) {
                            console.log(`Error procesando fecha ${ruta.fecha}:`, e);
                        }
                    }
                    
                    // Preparar HTML de notas
                    let notasHtml = '';
                    if (notasResult.success && notasResult.notas.length > 0) {
                        notasHtml = `
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #D2691E;">
                                <h5 style="margin-bottom: 15px; color: #D2691E;">üìù Notas del Mes (${notasResult.notas.length} notas)</h5>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${notasResult.notas.map(nota => `
                                        <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                            <strong style="color: #333; display: block; margin-bottom: 5px;">${nota.titulo}</strong>
                                            <p style="margin: 8px 0; color: #666; font-size: 14px; line-height: 1.4;">${nota.contenido}</p>
                                            <small style="color: #999; font-size: 12px;">
                                                üìÖ ${formatearFecha(nota.fecha)} | 
                                                üë§ ${nota.nombreUsuario}
                                            </small>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Mostrar reporte mensual
                    div.innerHTML = `
                        <h4>üìä Reporte de ${getNombreMes(mes)} ${ano}</h4>
                        <div class="report-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                            <div>
                                <h5>üìà Totales Generales</h5>
                                <div class="table-container">
                                    <table style="width: 100%; font-size: 14px;">
                                        <tr><th>Concepto</th><th>Cantidad</th></tr>
                                        <tr><td>Kilos</td><td>${parseFloat(totalKilos.toFixed(2))}</td></tr>
                                        <tr><td>Frijoles</td><td>${parseFloat(totalFrijoles.toFixed(2))}</td></tr>
                                        <tr><td>Salsas</td><td>${parseFloat(totalSalsas.toFixed(2))}</td></tr>
                                        <tr><td>Totopos</td><td>${parseFloat(totalTotopos.toFixed(2))}</td></tr>
                                        <tr><td>Cambios</td><td>${parseFloat(totalCambios.toFixed(2))}</td></tr>
                                        <tr style="background: #e8f5e8; font-weight: bold;">
                                            <td>TOTAL IMPORTE</td><td>$${totalImporte.toFixed(2)}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <h5>üìÖ Resumen por Fechas</h5>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${reportesPorFecha.map(r => `
                                        <div style="padding: 5px; border-bottom: 1px solid #eee;">
                                            <strong>${r.fecha}</strong><br>
                                            <small>$${r.importe.toFixed(2)} - ${r.tiendas} tiendas</small>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <p style="margin-top: 15px; color: #666;">
                            <strong>Total de d√≠as registrados:</strong> ${rutasDelMes.length}<br>
                            <strong>Promedio diario:</strong> $${(totalImporte / rutasDelMes.length).toFixed(2)}
                        </p>
                        ${notasHtml}
                    `;
                    
                    // Mostrar botones de exportaci√≥n
                    document.getElementById('btnExcel').style.display = 'inline-block';
                    document.getElementById('btnPDF').style.display = 'inline-block';
                    
                    // Guardar datos para exportaci√≥n (incluyendo notas)
                    window.reporteData = {
                        mes: getNombreMes(mes),
                        ano: ano,
                        totales: {
                            kilos: totalKilos,
                            frijoles: totalFrijoles,
                            salsas: totalSalsas,
                            totopos: totalTotopos,
                            cambios: totalCambios,
                            importe: totalImporte
                        },
                        fechas: reportesPorFecha,
                        diasRegistrados: rutasDelMes.length,
                        promedioDiario: totalImporte / rutasDelMes.length,
                        notas: notasResult.success ? notasResult.notas : []
                    };
                } else {
                    div.innerHTML = '<p>No hay datos disponibles para generar el reporte</p>';
                    document.getElementById('btnExcel').style.display = 'none';
                    document.getElementById('btnPDF').style.display = 'none';
                }
            } catch (error) {
                document.getElementById('reporteCompleto').innerHTML = '<p>Error generando reporte mensual</p>';
                console.error('Error:', error);
            }
        }

        function getNombreMes(numeroMes) {
            const meses = [
                '', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return meses[parseInt(numeroMes)];
        }

        async function generarReporteCompleto() {
            try {
                const response = await fetch(`${API_BASE}/registros/rutas-existentes`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                const result = await response.json();
                const div = document.getElementById('reporteCompleto');
                
                if (result.success && result.rutas.length > 0) {
                    let totalKilos = 0, totalFrijoles = 0, totalSalsas = 0, totalTotopos = 0, totalCambios = 0;
                    let totalImporte = 0;
                    let reportesPorFecha = [];
                    
                    // Generar reporte para cada fecha
                    for (const ruta of result.rutas) {
                        try {
                            const reporteResponse = await fetch(`${API_BASE}/registros/reporte-dia?fecha=${ruta.fecha}`, {
                                headers: { 'Authorization': `Bearer ${getToken()}` }
                            });
                            const reporteResult = await reporteResponse.json();
                            
                            if (reporteResult.success && reporteResult.reporte) {
                                const r = reporteResult.reporte;
                                totalKilos += r.totalKilos || 0;
                                totalFrijoles += r.totalFrijoles || 0;
                                totalSalsas += r.totalSalsas || 0;
                                totalTotopos += r.totalTotopos || 0;
                                totalCambios += r.totalCambios || 0;
                                totalImporte += r.importeTotal || 0;
                                
                                reportesPorFecha.push({
                                    fecha: ruta.fecha,
                                    importe: r.importeTotal || 0,
                                    tiendas: r.numTiendas || 0
                                });
                            }
                        } catch (e) {
                            console.log(`Error procesando fecha ${ruta.fecha}:`, e);
                        }
                    }
                    
                    // Mostrar reporte completo
                    div.innerHTML = `
                        <h4>üìä Reporte Completo del Sistema</h4>
                        <div class="report-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                            <div>
                                <h5>üìà Totales Generales</h5>
                                <div class="table-container">
                                    <table style="width: 100%; font-size: 14px;">
                                        <tr><th>Concepto</th><th>Cantidad</th></tr>
                                        <tr><td>Kilos</td><td>${parseFloat(totalKilos.toFixed(2))}</td></tr>
                                        <tr><td>Frijoles</td><td>${parseFloat(totalFrijoles.toFixed(2))}</td></tr>
                                        <tr><td>Salsas</td><td>${parseFloat(totalSalsas.toFixed(2))}</td></tr>
                                        <tr><td>Totopos</td><td>${parseFloat(totalTotopos.toFixed(2))}</td></tr>
                                        <tr><td>Cambios</td><td>${parseFloat(totalCambios.toFixed(2))}</td></tr>
                                        <tr style="background: #e8f5e8; font-weight: bold;">
                                            <td>TOTAL IMPORTE</td><td>$${totalImporte.toFixed(2)}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <h5>üìÖ Resumen por Fechas</h5>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${reportesPorFecha.map(r => `
                                        <div style="padding: 5px; border-bottom: 1px solid #eee;">
                                            <strong>${r.fecha}</strong><br>
                                            <small>$${r.importe.toFixed(2)} - ${r.tiendas} tiendas</small>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <p style="margin-top: 15px; color: #666;">
                            <strong>Total de d√≠as registrados:</strong> ${result.rutas.length}<br>
                            <strong>Promedio diario:</strong> $${(totalImporte / result.rutas.length).toFixed(2)}
                        </p>
                    `;
                    
                    // Mostrar botones de exportaci√≥n
                    document.getElementById('btnExcel').style.display = 'inline-block';
                    document.getElementById('btnPDF').style.display = 'inline-block';
                    
                    // Guardar datos para exportaci√≥n
                    window.reporteData = {
                        totales: {
                            kilos: totalKilos,
                            frijoles: totalFrijoles,
                            salsas: totalSalsas,
                            totopos: totalTotopos,
                            cambios: totalCambios,
                            importe: totalImporte
                        },
                        fechas: reportesPorFecha,
                        diasRegistrados: result.rutas.length,
                        promedioDiario: totalImporte / result.rutas.length
                    };
                } else {
                    div.innerHTML = '<p>No hay datos disponibles para generar el reporte</p>';
                }
            } catch (error) {
                document.getElementById('reporteCompleto').innerHTML = '<p>Error generando reporte completo</p>';
            }
        }

        // Funci√≥n para exportar a Excel
        function exportarExcel() {
            if (!window.reporteData) {
                alert('Primero genera un reporte mensual');
                return;
            }

            const data = window.reporteData;
            const wb = XLSX.utils.book_new();
            
            // T√≠tulo del reporte con mes/a√±o
            const titulo = data.mes && data.ano ? 
                `REPORTE COMAL - ${data.mes.toUpperCase()} ${data.ano}` : 
                'REPORTE COMAL - TOTALES GENERALES';
            
            // Hoja 1: Totales Generales
            const totalesData = [
                [titulo],
                [''],
                ['Concepto', 'Cantidad'],
                ['Kilos', data.totales.kilos],
                ['Frijoles', data.totales.frijoles.toFixed(2)],
                ['Salsas', data.totales.salsas],
                ['Totopos', data.totales.totopos],
                ['Cambios', data.totales.cambios],
                [''],
                ['TOTAL IMPORTE', '$' + data.totales.importe.toFixed(2)],
                [''],
                ['Total d√≠as registrados', data.diasRegistrados],
                ['Promedio diario', '$' + data.promedioDiario.toFixed(2)]
            ];
            
            const wsTotales = XLSX.utils.aoa_to_sheet(totalesData);
            XLSX.utils.book_append_sheet(wb, wsTotales, 'Totales');
            
            // Hoja 2: Detalle por Fechas
            const fechasData = [
                ['REPORTE POR FECHAS'],
                [''],
                ['Fecha', 'Importe', 'Tiendas']
            ];
            
            data.fechas.forEach(f => {
                fechasData.push([f.fecha, '$' + f.importe.toFixed(2), f.tiendas]);
            });
            
            const wsFechas = XLSX.utils.aoa_to_sheet(fechasData);
            XLSX.utils.book_append_sheet(wb, wsFechas, 'Por Fechas');
            
            // Hoja 3: Notas del Per√≠odo
            if (data.notas && data.notas.length > 0) {
                const notasData = [
                    ['NOTAS DEL PER√çODO'],
                    [''],
                    ['Fecha', 'T√≠tulo', 'Contenido', 'Autor']
                ];
                
                data.notas.forEach(nota => {
                    const fechaNota = formatearFecha(nota.fecha);
                    notasData.push([
                        fechaNota,
                        nota.titulo,
                        nota.contenido,
                        nota.nombreUsuario || 'Usuario'
                    ]);
                });
                
                const wsNotas = XLSX.utils.aoa_to_sheet(notasData);
                
                // Ajustar ancho de columnas para mejor legibilidad
                wsNotas['!cols'] = [
                    { wch: 12 }, // Fecha
                    { wch: 25 }, // T√≠tulo
                    { wch: 50 }, // Contenido
                    { wch: 15 }  // Autor
                ];
                
                XLSX.utils.book_append_sheet(wb, wsNotas, 'Notas');
            }
            
            // Descargar archivo con nombre espec√≠fico del mes
            const hoy = new Date();
            const fechaHoy = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
            const nombreArchivo = data.mes && data.ano ? 
                `Reporte_Comal_${data.mes}_${data.ano}.xlsx` : 
                `Reporte_Comal_${fechaHoy}.xlsx`;
            XLSX.writeFile(wb, nombreArchivo);
        }

        // Funci√≥n para exportar a PDF
        function exportarPDF() {
            if (!window.reporteData) {
                alert('Primero genera un reporte mensual');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = window.reporteData;
            
            // T√≠tulo con mes/a√±o
            doc.setFontSize(20);
            const titulo = data.mes && data.ano ? 
                `REPORTE COMAL - ${data.mes.toUpperCase()} ${data.ano}` : 
                'REPORTE COMAL';
            doc.text(titulo, 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            const fecha = new Date().toLocaleDateString('es-MX');
            doc.text(`Generado: ${fecha}`, 105, 30, { align: 'center' });
            
            // Totales Generales
            doc.setFontSize(16);
            doc.text('TOTALES GENERALES', 20, 50);
            
            const totalesTable = [
                ['Concepto', 'Cantidad'],
                ['Kilos', data.totales.kilos.toString()],
                ['Frijoles', data.totales.frijoles.toFixed(2)],
                ['Salsas', data.totales.salsas.toString()],
                ['Totopos', data.totales.totopos.toString()],
                ['Cambios', data.totales.cambios.toString()],
                ['TOTAL IMPORTE', '$' + data.totales.importe.toFixed(2)]
            ];
            
            doc.autoTable({
                head: [totalesTable[0]],
                body: totalesTable.slice(1),
                startY: 60,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] },
                styles: { fontSize: 10 }
            });
            
            // Resumen
            let finalY = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(12);
            doc.text(`Total d√≠as registrados: ${data.diasRegistrados}`, 20, finalY);
            doc.text(`Promedio diario: $${data.promedioDiario.toFixed(2)}`, 20, finalY + 10);
            
            // Detalle por fechas (nueva p√°gina si es necesario)
            if (finalY > 200) {
                doc.addPage();
                finalY = 20;
            } else {
                finalY += 30;
            }
            
            doc.setFontSize(16);
            doc.text('DETALLE POR FECHAS', 20, finalY);
            
            const fechasTable = data.fechas.map(f => [
                f.fecha,
                '$' + f.importe.toFixed(2),
                f.tiendas.toString()
            ]);
            
            doc.autoTable({
                head: [['Fecha', 'Importe', 'Tiendas']],
                body: fechasTable,
                startY: finalY + 10,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] },
                styles: { fontSize: 9 }
            });
            
            // Secci√≥n de Notas (si existen)
            if (data.notas && data.notas.length > 0) {
                finalY = doc.lastAutoTable.finalY + 30;
                
                // Nueva p√°gina si no hay espacio suficiente
                if (finalY > 220) {
                    doc.addPage();
                    finalY = 20;
                }
                
                doc.setFontSize(16);
                doc.text(`NOTAS DEL PER√çODO (${data.notas.length} notas)`, 20, finalY);
                
                const notasTable = data.notas.map(nota => {
                    const fechaNota = formatearFecha(nota.fecha);
                    // Limitar contenido para que quepa en el PDF
                    const contenidoCorto = nota.contenido.length > 80 ? 
                        nota.contenido.substring(0, 80) + '...' : 
                        nota.contenido;
                    
                    return [
                        fechaNota,
                        nota.titulo,
                        contenidoCorto,
                        nota.nombreUsuario || 'Usuario'
                    ];
                });
                
                doc.autoTable({
                    head: [['Fecha', 'T√≠tulo', 'Contenido', 'Autor']],
                    body: notasTable,
                    startY: finalY + 10,
                    theme: 'grid',
                    headStyles: { fillColor: [210, 105, 30] }, // Color naranja del tema
                    styles: { 
                        fontSize: 8,
                        cellPadding: 3,
                        overflow: 'linebreak',
                        columnWidth: 'wrap'
                    },
                    columnStyles: {
                        0: { cellWidth: 25 }, // Fecha
                        1: { cellWidth: 40 }, // T√≠tulo
                        2: { cellWidth: 80 }, // Contenido
                        3: { cellWidth: 30 }  // Autor
                    }
                });
            }
            
            // Descargar con nombre espec√≠fico del mes
            const hoy = new Date();
            const fechaHoy = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;
            const nombreArchivo = data.mes && data.ano ? 
                `Reporte_Comal_${data.mes}_${data.ano}.pdf` : 
                `Reporte_Comal_${fechaHoy}.pdf`;
            doc.save(nombreArchivo);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            verificarAutenticacion();
            inicializarFechas();
        });
    </script>
</body>
</html>
