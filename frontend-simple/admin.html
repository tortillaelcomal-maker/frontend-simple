<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sistema Comal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #D2691E 0%, #FF6347 50%, #FFD700 100%);
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('img/LogoComal.jpg') center/cover;
            opacity: 0.05;
            z-index: -1;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: linear-gradient(135deg, #D2691E 0%, #FF6347 100%);
            color: white; 
            padding: 1rem; 
            text-align: center; 
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(210, 105, 30, 0.3);
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('img/LogoComal.jpg') center/cover;
            opacity: 0.1;
            z-index: 0;
        }
        .header-content {
            position: relative;
            z-index: 1;
        }
        .logo-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .logo-header img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .header h1 {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(210, 105, 30, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        .btn { 
            background: linear-gradient(135deg, #D2691E 0%, #FF6347 100%);
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 10px; 
            cursor: pointer; 
            margin: 5px; 
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn:hover { 
            background: linear-gradient(135deg, #B8860B 0%, #CD5C5C 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(210, 105, 30, 0.4);
        }
        .user-info { text-align: right; margin-bottom: 10px; color: #666; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; }
        th { 
            background: linear-gradient(135deg, rgba(210, 105, 30, 0.1) 0%, rgba(255, 215, 0, 0.1) 100%);
            color: #8B4513;
            border-bottom: 2px solid rgba(210, 105, 30, 0.2);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .dashboard { grid-template-columns: 1fr; gap: 15px; }
            .card { padding: 15px; }
            .btn { padding: 8px 15px; font-size: 13px; margin: 3px; }
            .header { padding: 15px; }
            .header h1 { font-size: 1.5rem; }
            .user-info { text-align: center; font-size: 14px; }
            
            /* Grid layout for report totals on mobile */
            .report-grid { 
                display: grid !important; 
                grid-template-columns: 1fr !important; 
                gap: 15px !important; 
            }
            
            /* Table responsive */
            table { font-size: 12px; }
            th, td { padding: 6px 4px; }
            
            /* Export buttons stack on mobile */
            .export-buttons { 
                display: flex; 
                flex-direction: column; 
                gap: 10px; 
                margin-top: 15px; 
            }
            .export-buttons .btn { 
                width: 100%; 
                margin: 0; 
            }
        }
        
        @media (max-width: 480px) {
            .container { padding: 5px; }
            .card { padding: 10px; }
            .btn { padding: 6px 12px; font-size: 12px; }
            .header h1 { font-size: 1.3rem; }
            
            /* Very small screens - make tables scrollable */
            .table-container { 
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch; 
            }
            table { min-width: 300px; }
            th, td { padding: 4px 2px; font-size: 11px; }
            
            /* Stack form elements */
            .form-row { 
                display: flex; 
                flex-direction: column; 
                gap: 10px; 
            }
            .form-row input, .form-row button { 
                width: 100%; 
            }
        }
        
        /* Utility classes for responsive design */
        .mobile-hidden { display: block; }
        .mobile-only { display: none; }
        
        @media (max-width: 768px) {
            .mobile-hidden { display: none; }
            .mobile-only { display: block; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo-header">
                    <img src="img/LogoComal.jpg" alt="Logo Tortillería El Comal">
                    <h1>Panel de Administración</h1>
                </div>
                <p>Sistema Comal</p>
            </div>
        </div>

        <div class="user-info">
            Admin: <span id="usuarioActual">-</span> | 
            <a href="#" onclick="cerrarSesion()" style="color: #666;">Cerrar Sesión</a>
        </div>

        <div class="dashboard">

            <div class="card">
                <h3>📊 Reportes de Ventas</h3>
                <div class="form-row" style="margin-bottom: 15px;">
                    <label>Fecha:</label>
                    <input type="date" id="fechaReporte" style="margin: 5px;">
                    <button class="btn" onclick="generarReporteDia()">Reporte Día</button>
                </div>
                <div id="resultadoReporte"></div>
            </div>

            <div class="card">
                <h3>📈 Reportes Automáticos</h3>
                <button class="btn" onclick="generarReporteCompleto()">Generar Reporte Completo</button>
                <div class="export-buttons" style="margin-top: 10px;">
                    <button class="btn" onclick="exportarExcel()" id="btnExcel" style="display: none; background-color: #28a745;">📄 Exportar Excel</button>
                    <button class="btn" onclick="exportarPDF()" id="btnPDF" style="display: none; background-color: #dc3545; margin-left: 10px;">📋 Exportar PDF</button>
                </div>
                <div id="reporteCompleto"></div>
            </div>

            <div class="card">
                <h3>📋 Rutas Recientes</h3>
                <button class="btn" onclick="verRutasRecientes()">Ver Rutas</button>
                <div id="rutasRecientes"></div>
            </div>

            <div class="card">
                <h3>🌮 Acceso Rápido</h3>
                <button class="btn" onclick="window.location.href='index.html'">Ver Sistema de Registros</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Libraries for Excel and PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="config.js"></script>
    <script>
        const API_BASE = CONFIG.API_BASE_URL;

        function getToken() {
            return localStorage.getItem('token');
        }

        function verificarAutenticacion() {
            const token = getToken();
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (payload.rol !== 'admin') {
                    window.location.href = 'index.html';
                    return;
                }
                document.getElementById('usuarioActual').textContent = payload.nombre || 'Admin';
            } catch (error) {
                window.location.href = 'login.html';
            }
        }

        function cerrarSesion() {
            if (confirm('¿Cerrar sesión?')) {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            }
        }


        function inicializarFechas() {
            const hoy = new Date();
            document.getElementById('fechaReporte').value = hoy.toISOString().split('T')[0];
        }

        async function generarReporteDia() {
            const fecha = document.getElementById('fechaReporte').value;
            if (!fecha) {
                alert('Selecciona una fecha');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/registros/reporte-dia?fecha=${fecha}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                const result = await response.json();
                const div = document.getElementById('resultadoReporte');
                
                if (result.success && result.reporte) {
                    const r = result.reporte;
                    div.innerHTML = `
                        <h4>📅 Reporte del ${fecha}</h4>
                        <table style="width: 100%; margin-top: 10px;">
                            <tr><th>Concepto</th><th>Cantidad</th><th>Importe</th></tr>
                            <tr><td>Kilos</td><td>${r.totalKilos}</td><td>$${r.importeKilos.toFixed(2)}</td></tr>
                            <tr><td>Frijoles</td><td>${r.totalFrijoles}</td><td>$${r.importeFrijoles.toFixed(2)}</td></tr>
                            <tr><td>Salsas</td><td>${r.totalSalsas}</td><td>$${r.importeSalsas.toFixed(2)}</td></tr>
                            <tr><td>Totopos</td><td>${r.totalTotopos}</td><td>$${r.importeTotopos.toFixed(2)}</td></tr>
                            <tr><td>Cambios</td><td>${r.totalCambios}</td><td>$${r.importeCambios.toFixed(2)}</td></tr>
                            <tr style="background: #e8f5e8; font-weight: bold;">
                                <td>TOTAL</td><td>${r.totalGeneral}</td><td>$${r.importeTotal.toFixed(2)}</td>
                            </tr>
                        </table>
                        <p style="margin-top: 10px;"><strong>Tiendas registradas:</strong> ${r.numTiendas}</p>
                    `;
                } else {
                    div.innerHTML = '<p>No hay datos para esta fecha</p>';
                }
            } catch (error) {
                document.getElementById('resultadoReporte').innerHTML = '<p>Error generando reporte</p>';
            }
        }


        async function verRutasRecientes() {
            try {
                const response = await fetch(`${API_BASE}/registros/rutas-existentes`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                const result = await response.json();
                const div = document.getElementById('rutasRecientes');
                
                if (result.success && result.rutas.length > 0) {
                    div.innerHTML = `
                        <table>
                            <tr><th>Fecha</th><th>Registros</th></tr>
                            ${result.rutas.slice(0, 5).map(r => `
                                <tr><td>${r.fecha}</td><td>${r.numTiendas}</td></tr>
                            `).join('')}
                        </table>
                    `;
                } else {
                    div.innerHTML = '<p>No hay rutas registradas</p>';
                }
            } catch (error) {
                document.getElementById('rutasRecientes').innerHTML = '<p>Error cargando rutas</p>';
            }
        }

        async function generarReporteCompleto() {
            try {
                const response = await fetch(`${API_BASE}/registros/rutas-existentes`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                
                const result = await response.json();
                const div = document.getElementById('reporteCompleto');
                
                if (result.success && result.rutas.length > 0) {
                    let totalKilos = 0, totalFrijoles = 0, totalSalsas = 0, totalTotopos = 0, totalCambios = 0;
                    let totalImporte = 0;
                    let reportesPorFecha = [];
                    
                    // Generar reporte para cada fecha
                    for (const ruta of result.rutas) {
                        try {
                            const reporteResponse = await fetch(`${API_BASE}/registros/reporte-dia?fecha=${ruta.fecha}`, {
                                headers: { 'Authorization': `Bearer ${getToken()}` }
                            });
                            const reporteResult = await reporteResponse.json();
                            
                            if (reporteResult.success && reporteResult.reporte) {
                                const r = reporteResult.reporte;
                                totalKilos += r.totalKilos || 0;
                                totalFrijoles += r.totalFrijoles || 0;
                                totalSalsas += r.totalSalsas || 0;
                                totalTotopos += r.totalTotopos || 0;
                                totalCambios += r.totalCambios || 0;
                                totalImporte += r.importeTotal || 0;
                                
                                reportesPorFecha.push({
                                    fecha: ruta.fecha,
                                    importe: r.importeTotal || 0,
                                    tiendas: r.numTiendas || 0
                                });
                            }
                        } catch (e) {
                            console.log(`Error procesando fecha ${ruta.fecha}:`, e);
                        }
                    }
                    
                    // Mostrar reporte completo
                    div.innerHTML = `
                        <h4>📊 Reporte Completo del Sistema</h4>
                        <div class="report-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                            <div>
                                <h5>📈 Totales Generales</h5>
                                <div class="table-container">
                                    <table style="width: 100%; font-size: 14px;">
                                        <tr><th>Concepto</th><th>Cantidad</th></tr>
                                        <tr><td>Kilos</td><td>${totalKilos}</td></tr>
                                        <tr><td>Frijoles</td><td>${totalFrijoles.toFixed(2)}</td></tr>
                                        <tr><td>Salsas</td><td>${totalSalsas}</td></tr>
                                        <tr><td>Totopos</td><td>${totalTotopos}</td></tr>
                                        <tr><td>Cambios</td><td>${totalCambios}</td></tr>
                                        <tr style="background: #e8f5e8; font-weight: bold;">
                                            <td>TOTAL IMPORTE</td><td>$${totalImporte.toFixed(2)}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div>
                                <h5>📅 Resumen por Fechas</h5>
                                <div style="max-height: 200px; overflow-y: auto;">
                                    ${reportesPorFecha.map(r => `
                                        <div style="padding: 5px; border-bottom: 1px solid #eee;">
                                            <strong>${r.fecha}</strong><br>
                                            <small>$${r.importe.toFixed(2)} - ${r.tiendas} tiendas</small>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <p style="margin-top: 15px; color: #666;">
                            <strong>Total de días registrados:</strong> ${result.rutas.length}<br>
                            <strong>Promedio diario:</strong> $${(totalImporte / result.rutas.length).toFixed(2)}
                        </p>
                    `;
                    
                    // Mostrar botones de exportación
                    document.getElementById('btnExcel').style.display = 'inline-block';
                    document.getElementById('btnPDF').style.display = 'inline-block';
                    
                    // Guardar datos para exportación
                    window.reporteData = {
                        totales: {
                            kilos: totalKilos,
                            frijoles: totalFrijoles,
                            salsas: totalSalsas,
                            totopos: totalTotopos,
                            cambios: totalCambios,
                            importe: totalImporte
                        },
                        fechas: reportesPorFecha,
                        diasRegistrados: result.rutas.length,
                        promedioDiario: totalImporte / result.rutas.length
                    };
                } else {
                    div.innerHTML = '<p>No hay datos disponibles para generar el reporte</p>';
                }
            } catch (error) {
                document.getElementById('reporteCompleto').innerHTML = '<p>Error generando reporte completo</p>';
            }
        }

        // Función para exportar a Excel
        function exportarExcel() {
            if (!window.reporteData) {
                alert('Primero genera un reporte completo');
                return;
            }

            const data = window.reporteData;
            const wb = XLSX.utils.book_new();
            
            // Hoja 1: Totales Generales
            const totalesData = [
                ['REPORTE COMAL - TOTALES GENERALES'],
                [''],
                ['Concepto', 'Cantidad'],
                ['Kilos', data.totales.kilos],
                ['Frijoles', data.totales.frijoles.toFixed(2)],
                ['Salsas', data.totales.salsas],
                ['Totopos', data.totales.totopos],
                ['Cambios', data.totales.cambios],
                [''],
                ['TOTAL IMPORTE', '$' + data.totales.importe.toFixed(2)],
                [''],
                ['Total días registrados', data.diasRegistrados],
                ['Promedio diario', '$' + data.promedioDiario.toFixed(2)]
            ];
            
            const wsTotales = XLSX.utils.aoa_to_sheet(totalesData);
            XLSX.utils.book_append_sheet(wb, wsTotales, 'Totales');
            
            // Hoja 2: Detalle por Fechas
            const fechasData = [
                ['REPORTE POR FECHAS'],
                [''],
                ['Fecha', 'Importe', 'Tiendas']
            ];
            
            data.fechas.forEach(f => {
                fechasData.push([f.fecha, '$' + f.importe.toFixed(2), f.tiendas]);
            });
            
            const wsFechas = XLSX.utils.aoa_to_sheet(fechasData);
            XLSX.utils.book_append_sheet(wb, wsFechas, 'Por Fechas');
            
            // Descargar archivo
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Reporte_Comal_${fecha}.xlsx`);
        }

        // Función para exportar a PDF
        function exportarPDF() {
            if (!window.reporteData) {
                alert('Primero genera un reporte completo');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = window.reporteData;
            
            // Título
            doc.setFontSize(20);
            doc.text('REPORTE COMAL', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            const fecha = new Date().toLocaleDateString('es-MX');
            doc.text(`Generado: ${fecha}`, 105, 30, { align: 'center' });
            
            // Totales Generales
            doc.setFontSize(16);
            doc.text('TOTALES GENERALES', 20, 50);
            
            const totalesTable = [
                ['Concepto', 'Cantidad'],
                ['Kilos', data.totales.kilos.toString()],
                ['Frijoles', data.totales.frijoles.toFixed(2)],
                ['Salsas', data.totales.salsas.toString()],
                ['Totopos', data.totales.totopos.toString()],
                ['Cambios', data.totales.cambios.toString()],
                ['TOTAL IMPORTE', '$' + data.totales.importe.toFixed(2)]
            ];
            
            doc.autoTable({
                head: [totalesTable[0]],
                body: totalesTable.slice(1),
                startY: 60,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] },
                styles: { fontSize: 10 }
            });
            
            // Resumen
            let finalY = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(12);
            doc.text(`Total días registrados: ${data.diasRegistrados}`, 20, finalY);
            doc.text(`Promedio diario: $${data.promedioDiario.toFixed(2)}`, 20, finalY + 10);
            
            // Detalle por fechas (nueva página si es necesario)
            if (finalY > 200) {
                doc.addPage();
                finalY = 20;
            } else {
                finalY += 30;
            }
            
            doc.setFontSize(16);
            doc.text('DETALLE POR FECHAS', 20, finalY);
            
            const fechasTable = data.fechas.map(f => [
                f.fecha,
                '$' + f.importe.toFixed(2),
                f.tiendas.toString()
            ]);
            
            doc.autoTable({
                head: [['Fecha', 'Importe', 'Tiendas']],
                body: fechasTable,
                startY: finalY + 10,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] },
                styles: { fontSize: 9 }
            });
            
            // Descargar
            const fechaArchivo = new Date().toISOString().split('T')[0];
            doc.save(`Reporte_Comal_${fechaArchivo}.pdf`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            verificarAutenticacion();
            inicializarFechas();
        });
    </script>
</body>
</html>
